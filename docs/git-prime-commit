#!/usr/bin/env python3
"""
git-prime-commit: Create git commits with prime SHA-1 hashes
"""
import subprocess
import sys
import os

def is_prime_miller_rabin(n, k=40):
    """Miller-Rabin primality test - probabilistic but very reliable"""
    if n < 2:
        return False
    if n == 2 or n == 3:
        return True
    if n % 2 == 0:
        return False

    # Write n-1 as 2^r * d
    r, d = 0, n - 1
    while d % 2 == 0:
        r += 1
        d //= 2

    # Witness loop
    import random
    for _ in range(k):
        a = random.randrange(2, n - 1)
        x = pow(a, d, n)

        if x == 1 or x == n - 1:
            continue

        for _ in range(r - 1):
            x = pow(x, 2, n)
            if x == n - 1:
                break
        else:
            return False

    return True

def get_commit_hash(message, author=None, date=None):
    """Create a commit and return its hash as an integer"""
    env = os.environ.copy()
    if author:
        env['GIT_AUTHOR_NAME'] = author[0]
        env['GIT_AUTHOR_EMAIL'] = author[1]
        env['GIT_COMMITTER_NAME'] = author[0]
        env['GIT_COMMITTER_EMAIL'] = author[1]
    if date:
        env['GIT_AUTHOR_DATE'] = date
        env['GIT_COMMITTER_DATE'] = date

    # Commit with the message
    result = subprocess.run(
        ['git', 'commit', '--allow-empty', '-m', message],
        capture_output=True,
        text=True,
        env=env
    )

    if result.returncode != 0:
        print(f"Error creating commit: {result.stderr}", file=sys.stderr)
        return None

    # Get the hash
    result = subprocess.run(
        ['git', 'rev-parse', 'HEAD'],
        capture_output=True,
        text=True
    )

    commit_hash = result.stdout.strip()
    return int(commit_hash, 16), commit_hash

def main():
    if len(sys.argv) < 2:
        print("Usage: git prime-commit <message>", file=sys.stderr)
        print("   or: git prime-commit -m <message>", file=sys.stderr)
        sys.exit(1)

    # Parse message
    if sys.argv[1] == '-m':
        if len(sys.argv) < 3:
            print("Error: -m requires a message", file=sys.stderr)
            sys.exit(1)
        base_message = sys.argv[2]
    else:
        base_message = ' '.join(sys.argv[1:])

    print(f"Searching for prime commit hash...")
    print(f"Base message: {base_message}")

    attempt = 0
    while True:
        # Fuzz the message with a nonce
        if attempt == 0:
            message = base_message
        else:
            message = f"{base_message}\n\ngit-prime Nonce: {attempt}"

        hash_int, hash_hex = get_commit_hash(message)
        if hash_int is None:
            sys.exit(1)

        attempt += 1

        if attempt % 10 == 0:
            print(f"Attempt {attempt}: {hash_hex[:16]}... ", end='', flush=True)

        if is_prime_miller_rabin(hash_int):
            print(f"\n[PRIME] Found after {attempt} attempts!")
            print(f"  Commit: {hash_hex}")
            print(f"  Hash as int: {hash_int}")
            print(f"  Message nonce: {attempt - 1 if attempt > 1 else 'none'}")
            break
        else:
            # Undo the commit and try again
            subprocess.run(['git', 'reset', '--soft', 'HEAD~1'],
                         capture_output=True)

            if attempt % 10 == 0:
                print("not prime")

if __name__ == '__main__':
    main()
